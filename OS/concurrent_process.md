# [운영체제] 병행 프로세스

* 병행 프로세스의 개념
* 동기화와 임계영역
* 프로세스의 상호 협력
* 프로세스 간의 통신

# 1. 병행 프로세스의 개념

## 병행성(Concurrency)

- 여러 개의 프로세스 또는 스레드가 동시에 실행되는 시스템의 특성
- 병행 프로세스란, 동시에 실행되는 여러 개의 프로세스 또는 쓰레드
- CPU가 하나, 프로세스가 세개 있다면 어떻게 처리할까 → 하나의 Cpu에서 각 프로세스가 짧은 시간 간격으로 번갈아 가며 실행되는 인터리빙 형식으로 실행
- CPU가 프로세스 개수만큼 있다면 → 병렬 처리 형식으로 실행

메모리 구조에 따른 병행 프로세스의 실행 형태
- 강결합 멀티프로세서 시스템(공유 메모리 구조) → 하나의 메모리를 여러 CPU가 공유
- 약결합 멀티프로세서 시스템(분산 메모리 구조) → CPU마다 메모리가 존재, 통신선을 통해 상호 커뮤니케이션

### 병행성 문제
병행 프로세스들이 상호작용하는 경우 발생
- 공유자원 점유 문제
- 동기화 문제
- 통신 문제

### 단일 프로세스 내의 병행성

순서 관계를 지켜야하는 프로세스 안에서도 동시에 발생할 수 있는 것을 찾을 수 있음. 찾는 방식으로 우선순위 그래프, 포크/조인 구조, 병행문이 있음

### 우선순위 그래프

정점과 간선이 존재

- 정점: 문장
- 방향있는 간선: 우선순위 관계

### Fork/Join(분할/결합) 구조
- fork L: 2개의 병행 수행을 만듦
- join n: 병행하는 n개의 흐름을 하나로 재결합

### 병행문

- 1개의 프로세스가 여러 가닥의 병렬 프로세스로 분할되었다가 다시 하나로 결합
- parbegin / parend 문

### 프로세스 간의 병행성

프로세스 간의 병행성은 프로세스가 서로 완전히 독립하여 수행되거나 다른 프로세스와 가끔 협력하면서 기능을 수행하는 방법으로 구분할 수 있다. 특히 프로세스간의 병행성에서 상호 협력하는 경우를 비동기적(어씽크)라고 말하며, 때때로 자원을 공유해야 되기 때문에 다소 복잡하다. 

### 동기화

똑같은 일이 순서대로 동일하게 진행되는 것

### 비동기 병행 프로세스

동기화 되지 않는 병행 프로세스.

그러나 비동기라고 하면 상관없이 진행되는데, 그럼에도 유기적인 프로세스가 필요하다. 

그런 유기적 프로세스일 경우에는 공유자원을 같이 사용하고 있다. 그런데 공유 자원은 한 순간에는 한 프로세스만 사용을 해야하는 경우가 있다. 그것이 프로세스간 병행성의 문제점이다. 

# 2. 동기화와 임계영역

### 프로세스 동기화

2개 이상의 프로세스에 대한 처리 순서를 결정하는 것

예: 동시에 사용할 수 없는 공유자원, 한 프로세스의 처리 결과에 따라 다른 프로세스의 처리가 영향을 받는 경우

### 임계영역

2개 이상의 프로세스가 동시에 액세스하면 안되는 공유자원을 액세스하는 코드 영역

### 상호배제

2개 이상의 프로세스가 동시에 임계영역에 진입하지 못하도록 하는 것

즉, 유기적인 병행 프로세스인 경우에 문제점이 발생하지 않으려면, 임계 영역을 잘 설정하고, 상호 배제를 해야함. 

## 임계영역 문제 해결을 위한 요구조건

### 상호배제

한 프로세스가 임계영역에서 실행 중일 때 다른 어떤 프로세스도 임계영역에서 실행 될 수 없음.

### 진행

임계영역에서 실행 중인 프로세스가 없고 여러 프로세스가 임계영역에 진입하고자 할 때 그 중에서 적절히 한 프로세스를 결정해야 하며 이 결정은 무한정 미룰 수 없음. 

### 제한된 대기

한 프로세스가 임계영역 진입 요청을 한 후 수락될때까지 다른 프로세스가 임계영역 진입을 허가받는 회수는 제한되어야 함.

## 임계영역 문제 해결을 위한 도구

- Test-and-Set
- 세마포어

### 테스트-앤-셋 명령어

- 상호배제의 하드웨어적 해결 방법

- 분리가 불가능한 단일 기계 명령어

- 많은 프로세스가 임계영역에 들어가기를 원할 때 기아(starvation)가 발생할 수 있음
  - 기아란, 프로세스가 필요한 자원할당을 받지 못하고 계속적으로 대기하게 되는 상황

- Busy waiting을 함으로써 다른 작업이 사용할 수 있는 cpu 사이클을 낭비 

### 세마포어

- 데이크스트라가 제안한 동기화 도구

- p와 v라는 원자연산에 의해서만 접근되는 정수형 공용변수인 세마포어를 이용하여 상호배제 및 동기화를 구현할 수 있음

- 세마포어 s: 사용 가능한 자원의 수 또는 잠김/열림 등의 상태를 나타내는 값을 저장하는 정수형 공용변수

- 세마포어 s는 두 표준단위 연산 p와 v에 의해서만 접근됨

- p(s) : 검사, 감소시키려는 시도

- v(s): 증가

동기화 문제 해결

- 프로세스 1이 문장 s1을 실행한 후

- 프로세스 2가 문장 s2를 실행하도록 동기화 (block / wakeup 프로토콜)

# 3. 프로세스의 상호 협력

병행 프로세스들의 상호 협력

- 공통 작업을 수행하기 위해 서로 협동하는 경우
- 예: 생산자/소비자 문제, 판독기/기록기 문제
- 두 예제 모두 각각 양쪽에 상호배제와 동기화를 요구하며 세마포어를 이용하여 실행한다.

### 생산자/소비자 문제

producer, consumer 프로듀서, 컨슈머 문제는 유한 버퍼(bounded buffer) 문제라고도 한다.

- 동기화 : 고정된 크기를 가진 버퍼를 사이에 두고 버퍼가 비어있다면 컨슈머가 기다리게 되고, 버퍼가 가득 차면 프로듀서가 기다리게 된다. 

- 상호 배제 : 생산자는 버퍼에 데이터를 채우는 프로세스를 수행, 소비자는 버퍼에 있는 데이터를 읽어내는 프로세스를 수행

## 판독기/기록기 문제

reader / writer

공유 데이터 객체(파일, 레코드 등)가 여러 병행 프로세스 간에 공유될 수 있다. 

읽을 때는 문제 없지만 데이터를 쓰는 경우에는 문제가 되므로 상호배제를 잘 해야한다.

### 우선순위에 따른 문제의 변형

- 제 1판독기/기록기 문제(판독기 우선)
  - 기록기가 이미 공유객체의 사용을 허가 받은 것이 아니라면 판독기는 대기하지 않음. 즉, 판독기가 읽고 있으면 기록기는 계속 대기함. → 기록기의 기아상태(계속 대기) 유발 가능
- 제 2판독기/기록기 문제(기록기 우선)
  - 일단 기록기가 준비되었다면 기록은 가능한 한 빨리 수행할 수 있도록 함. 즉, 기록기가 접근하기 위해 대기중일때는 어떠한 새로운 판독기도 읽기를 시작할 수 없다. → 판독기의 기아상태 유발 가능

# 4. 프로세스 간의 통신

이 문제들은 협력하려는 프로세스 간의 통신(communication)을 허락하는 문제의 예로도 볼 수 있다. 원칙적으로 2개의 상호 보완적인 통신 프로세스가 통신하는 기법에는 두 가지가 있다. 

- 공유 기억장치 기법(shared memory)
- 메시지 시스템 기법(message system)

이 두가지 방법은 상호 배타적이 아닌, 단일 운영체제 내에서 동시에 사용된다. 

## 공유 기억장치 기법

공유 기억장치 기법은 통신하는 프로세스 간에 어떤 변수를 공유하도록 하여 프로세스가 이런 공유변수를 이용하여 정보를 교환하도록 하는 것으로, 앞에서 설명한 유한 버퍼가 한 예이다. 

고속 통신이 가능하며, 통신 기능을 제공하는 책임은 응용 프로그래머에게 달려 있고 운영체제는 단지 공유 기억장소만을 제공한다.

## 메시지 시스템 기법

메시지 교환 방식으로 정보를 교환한다. 공유변수에 의존하지 않고 서로 통신할 수 있게 한다.

send / receive 연산자가 사용된다. 둘은 커널을 거쳐가서 메시지를 주고받는다. 

소량의 데이터 교환에 유용하고 통신을 제공하는 책임은 운영체제에 있다.

### 통신 링크

프로세스들 사이에 메시지를 주고받기 위한 연결 통로

### 직접 통신(direct communication)

메시지 전달 연산에 수신자나 송신자 이름을 명시

- 통신 링크는 자동 설정됨
- 하나의 링크는 두 프로세스 사이만 연관되며 각 통신 프로세스 쌍 사이에는 정확히 하나의 링크가 존재
- 링크는 양방향임

이 방법은 주소 지정에서 대칭성을 보여준다. 즉, 상대방을 명시해야 하는데 

비대칭형 통신은 단지 전송자만이 수신자를 명시하고, 수신자는 송신자의 이름을 알 필요가 없다. 

### 간접 통신(indirect communication)

메시지 전달 연산에 우편함(mailbox or ports) 이름을 명시

프로세스에 직접 보내는 것이 아니라 중간에 있는 우편함에 메시지를 전송하고, 우편함으로부터 메시지를 수신함. 

- 통신 링크는 공유 포트(우편함)가 있는 경우에만 설정됨
- 하나의 링크는 2개 이상의 프로세스들과 연관될 수 있으며 각 프로세스 쌍 사이에는 여러 링크가 존재 가능
- 링크는 단방향 또는 양방향임

- 우편함이 프로세스에 소속되는 경우, 우편함을 가지고 있는 프로세스는 수신만 가능, 아닌 프로세스는 송신만 가능 → 즉 단방향

- 우편함이 운영체제에 소속되는 경우, 공통된 운영체제가 우편함을 갖고있다면 양방향 가능

### 링크의 용량

링크는 자체 안에 임시로 저장되는 메시지의 수를 결정하는 용량을 갖는다. 이런 특성은 링크에 붙여지는 메시지의 큐로써 생각될 수 있다. 기본적으로 이런 큐를 구현하는 방법에는 세 가지가 있다.

- 0 용량
  - 큐 없음, 바로 받아야함.
- 제한된 용량
  - n이라는 크기로 제한된 용량을 가진다.
- 무제한 용량
  - 큐가 무한한 길이를 가지고 있다. 송신자는 기다리지 않아도 된다.

- 큐가 없는 경우 바로 받아야하기 때문에 동기화 필요

- 큐가 있는 경우 자동 버퍼링을 제공한다.

- 0 용량이 아닌 경우 메시지 도착 여부의 인지 방법
  - 중간에 버퍼가 있으면 버퍼에 던져놓은 것을 수신자가 받았는지 안받았는지 모른다.
  - 이것을 해결하기 위해 버퍼가 있을때 보내고 나서 수신자가 받았는지 체크하기 위해 수신자가 받은 다음, 송신자 쪽에 ack라고 하는 것을 보내주는 작업을 한다. 이것을 비동기적 통신이라고 한다. 

### 예외조건 처리

메시지 시스템은 분산환경에서 유용한데, 이 환경에서 프로세스는 서로 다른 시스템에 위치한다. 이럴 경우 통신과 처리의 오류가 발생할 확률은 단일 시스템 환경보다 크다. 그러나 분산 환경에서는 메시지가 보통 통신 라인에서 처리되고, 한곳에서의 고장이 전체 시스템의 고장을 초래하지 않는다.

 분산 시스템에서 오류가 생겼을 때는 예외 조건 처리가 필요하다.

- 프로세스가 종료된 경우
- 메시지를 상실한 경우
- 메시지가 혼합된 경우

송신 프로세스가 종료된 경우 

- 수신 프로세스를 종료한다
- 송신 프로세스가 종료한 사실을 수신자에게 알림

수신 프로세스가 종료된 경우 

- 버퍼가 없는 경우 송신 프로세스를 종료한다.
- 수신자가 종료한 사실을 송신자에게 알려준다.

메시지 상실의 경우

중간에 통신 링크에 문제가 생겨서 메시지가 상실됨. 송신은 했는데 수신은 못하는 상황

- 운영체제가 탐지 후 메시지 재전송
- 송신 프로세스가 탐지 후 메시지 재전송
- 운영체제가 탐지 후 송신 프로세스에게 통지

모두 탐지가 필요한데 탐지 방법으로 시간 제한이 있음. 

어떤 특정한 시간이 지난 다음에 ack를 받지 못했다면 메시지 상실로 판단, 재전송함.

메시지 혼합의 경우

- 오류 탐지 후 재전송

탐지 방법으로 검사합계(checksum)이 있음. 원래 보낼 메시지로부터 어떤 특정한 값을 만들어서 같이 보내준다. 수신자 입장에서는 같이 왔던 값이 아니라 다른 값이 만들어졌다면, 즉 체크섬과 일치하지 않는 결과가 나오면 메시지가 변질되었다고 판단.